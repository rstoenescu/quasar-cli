#!/usr/bin/env node

const
  fs = require('fs'),
  parseArgs = require('minimist'),
  chalk = require('chalk'),
  spawn = require('../lib/helpers/spawn'),
  log = require('../lib/helpers/logger')('app:mode'),
  appPaths = require('../lib/build/app-paths'),
  logger = require('../lib/helpers/logger'),
  warn = logger('app:mode-test', 'red')

  if (!fs.existsSync(appPaths.testDir)) {
  warn(`
  Code coverage not setup. Please run:
   
    $ quasar mode --add test 
    
    `)
  return
}

const argv = parseArgs(process.argv.slice(2), {
  alias: {
    h: 'help'
  },
  string: ['a', 'r'],
  boolean: ['h', 'c', 'u']
})

// const unitTests = ['cross-env NODE_ENV=test', 'mocha-webpack', '--webpack-config', 'test/webpack.test.js', '--require', 'test/setup.js', 'test/**/*.spec.js']
// const coverageTests = ['cross-env NODE_ENV=test nyc --reporter=lcov mocha-webpack --webpack-config test/webpack.config-test.js --require test/setup.js test/**/*.spec.js']
// "test": "cross-env NODE_ENV=test nyc --reporter=lcov --reporter=text mocha test/*.js"

if (argv.help) {
  // these options are taken from https://github.com/vuejs/vue-cli/tree/dev/packages/%40vue/cli-plugin-unit-mocha
  console.log(`
    Description
      This runs code coverage on the whole app.

     Options     
      --watch, -w     run in watch mode
      --grep, -g      only run tests matching <pattern>
      --slow, -s      "slow" test threshold in milliseconds
      --timeout, -t   timeout threshold in milliseconds
      --bail, -b      bail after first test failure
      
      --help, -h     Displays this message

    Usage
      # run all unit tests currently installed
      $ quasar test

      # run all unit tests code coverage currently installed
      $ quasar test coverage

      # determine what tests are currently installed:
      $ quasar test list

  `)
  process.exit(0)
}

require('../lib/helpers/ensure-argv')(argv, 'mode')
const getMode = require('../lib/mode')

// choose reporter from command line
log(`Starting Tests`)
spawn.sync('./node_modules/cross-env/dist/bin/cross-env.js',
  ['NODE_ENV=test', './node_modules/nyc/bin/nyc.js', 'report', '--webpack-config ./test/webpack.test.js', '--require ./test/setup.js test/**/*.spec.js'])
// spawn.sync('./node_modules/nyc/bin/nyc.js',
//  ['report', '--webpack-config test/webpack.test.js', '--require test/setup.js test/**/*.spec.js'])



if (argv.add) {
  getMode(argv.add).add()
  process.exit(0)
}
else if (argv.remove) {
  getMode(argv.remove).remove()
  process.exit(0)
}
